name: Security

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly security audit
    - cron: '0 0 * * 0'

jobs:
  lint-and-typecheck:
    name: Lint & Typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Lint
        run: bunx eslint app lib components --ext .ts,.tsx --max-warnings 0 || echo "::warning::ESLint found issues"
        continue-on-error: true
      
      - name: Typecheck
        run: bun run typecheck

  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Run npm audit
        run: |
          # Convert bun.lock to package-lock for npm audit compatibility
          npm i --package-lock-only 2>/dev/null || true
          npm audit --audit-level=high || echo "::warning::npm audit found issues"
        continue-on-error: true
      
      - name: Check for known vulnerabilities
        run: |
          # Check critical packages manually
          echo "Checking critical dependencies..."
          
          # Check next-auth version
          NEXTAUTH_VERSION=$(cat package.json | grep '"next-auth"' | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
          echo "next-auth version: $NEXTAUTH_VERSION"
          
          # Check bcryptjs version
          BCRYPT_VERSION=$(cat package.json | grep '"bcryptjs"' | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
          echo "bcryptjs version: $BCRYPT_VERSION"

  secret-scan:
    name: Secret Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check for hardcoded secrets
        run: |
          echo "Scanning for potential secrets..."
          
          # Patterns to search for (common secret formats)
          PATTERNS=(
            'sk_live_[a-zA-Z0-9]+'
            'sk_test_[a-zA-Z0-9]+'
            'whsec_[a-zA-Z0-9]+'
            'sk-[a-zA-Z0-9]{20,}'
            'AKIA[A-Z0-9]{16}'
            'ya29\.[a-zA-Z0-9_-]+'
            'AIza[a-zA-Z0-9_-]{35}'
          )
          
          # Files/directories to exclude from scan (test files with fake secrets, examples, etc.)
          EXCLUDE_PATTERNS="node_modules|\.env\.example|bun\.lock|tests/security/|\.test\.ts|\.spec\.ts"
          
          FOUND_SECRETS=0
          
          for pattern in "${PATTERNS[@]}"; do
            MATCHES=$(grep -rE "$pattern" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.json" . 2>/dev/null | grep -vE "$EXCLUDE_PATTERNS" || true)
            if [ -n "$MATCHES" ]; then
              echo "::error::Potential secret found matching pattern: $pattern"
              echo "$MATCHES" | head -5
              FOUND_SECRETS=1
            fi
          done
          
          if [ $FOUND_SECRETS -eq 1 ]; then
            echo "::error::Secret scan failed - potential secrets found in code"
            exit 1
          fi
          
          echo "No hardcoded secrets found"

  security-headers-test:
    name: Security Headers Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Verify proxy exists
        run: |
          if [ ! -f "proxy.ts" ]; then
            echo "::error::proxy.ts not found - security headers may not be applied"
            exit 1
          fi
          echo "proxy.ts found"
      
      - name: Check security header configuration
        run: |
          # Verify security headers are defined in proxy
          REQUIRED_HEADERS=(
            "X-Frame-Options"
            "X-Content-Type-Options"
            "Strict-Transport-Security"
            "Content-Security-Policy"
          )
          
          for header in "${REQUIRED_HEADERS[@]}"; do
            if grep -q "$header" proxy.ts; then
              echo "âœ“ $header configured"
            else
              echo "::warning::$header may not be configured in proxy"
            fi
          done

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Run unit tests
        run: bun run test:unit
        continue-on-error: true

  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Run security tests
        run: |
          # Run security-specific tests if they exist
          if [ -d "tests/security" ]; then
            bun test tests/security
          else
            echo "No security tests found in tests/security"
          fi
        continue-on-error: true

  production-config-check:
    name: Production Config Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check for debug flags in production code
        run: |
          echo "Checking for debug flags that should be disabled in production..."
          
          # Check for console.log in production code (excluding tests)
          CONSOLE_LOGS=$(grep -rn "console\.log" app/ lib/ --include="*.ts" --include="*.tsx" | grep -v "\.test\." | grep -v "\.spec\." | wc -l)
          if [ "$CONSOLE_LOGS" -gt 50 ]; then
            echo "::warning::High number of console.log statements ($CONSOLE_LOGS) - consider using structured logger"
          fi
          
          # Check for hardcoded localhost references
          LOCALHOST_REFS=$(grep -rn "localhost" app/ lib/ --include="*.ts" --include="*.tsx" | grep -v "\.test\." | grep -v "env\.example" | wc -l)
          if [ "$LOCALHOST_REFS" -gt 5 ]; then
            echo "::warning::Found $LOCALHOST_REFS localhost references - ensure they use env vars in production"
          fi
          
          echo "Production config check completed"
