generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model User {
  id                Int                 @id @default(autoincrement())
  email             String              @unique(map: "uq_user_email") @db.VarChar(255)
  name              String?             @db.VarChar(255)
  passwordHash      String?             @db.VarChar(255)
  createdAt         DateTime            @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime            @default(now()) @updatedAt @db.Timestamptz(6)
  Channel           Channel[]
  GoogleAccount     GoogleAccount[]
  OAuthState        OAuthState[]
  Subscription      Subscription?
  Plan              Plan[]
  UserModel         UserModel?
  UserTrainingAsset UserTrainingAsset[]
  ThumbnailJobs     ThumbnailJob[]
  ThumbnailProjects ThumbnailProject[]

  @@index([email], map: "idx_user_email")
}

model Subscription {
  id                   Int       @id @default(autoincrement())
  userId               Int       @unique
  stripeCustomerId     String?   @db.VarChar(255)
  stripeSubscriptionId String?   @db.VarChar(255)
  status               String    @default("inactive") @db.VarChar(32) // active, past_due, canceled, inactive
  plan                 String    @default("free") @db.VarChar(32) // free, pro, team
  currentPeriodEnd     DateTime? @db.Timestamptz(6)
  cancelAtPeriodEnd    Boolean   @default(false)
  cancelAt             DateTime? @db.Timestamptz(6)
  canceledAt           DateTime? @db.Timestamptz(6)
  channelLimit         Int       @default(1)
  createdAt            DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt            DateTime  @default(now()) @updatedAt @db.Timestamptz(6)
  User                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([stripeCustomerId], map: "idx_subscription_stripe_customer")
  @@index([stripeSubscriptionId], map: "idx_subscription_stripe_sub")
}

model GoogleAccount {
  id                Int       @id @default(autoincrement())
  userId            Int
  provider          String    @default("google") @db.VarChar(50)
  providerAccountId String    @db.VarChar(255)
  refreshTokenEnc   String?
  accessTokenEnc    String? // Cached access token (stored to avoid race conditions across workers)
  scopes            String?
  tokenExpiresAt    DateTime? @db.Timestamptz(6)
  createdAt         DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime  @default(now()) @updatedAt @db.Timestamptz(6)
  User              User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_google_user")
  Channel           Channel[]

  @@unique([provider, providerAccountId], map: "uq_google_provider_account")
}

model Channel {
  id               Int             @id @default(autoincrement())
  userId           Int
  googleAccountId  Int? // Which GoogleAccount owns this channel (for multi-account support)
  youtubeChannelId String          @db.VarChar(128)
  title            String?         @db.VarChar(255)
  thumbnailUrl     String?
  totalVideoCount  Int? // Total videos on YouTube (from API statistics)
  subscriberCount  Int? // Subscriber count (from API statistics)
  connectedAt      DateTime        @default(now()) @db.Timestamptz(6)
  lastSyncedAt     DateTime?       @db.Timestamptz(6)
  syncStatus       String          @default("idle") @db.VarChar(32)
  syncError        String?
  User             User            @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_channel_user")
  GoogleAccount    GoogleAccount?  @relation(fields: [googleAccountId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  Video            Video[]
  Plan             Plan[]
  VideoMetrics     VideoMetrics[]
  ChannelNiche     ChannelNiche?
  ChannelProfile   ChannelProfile?

  @@unique([userId, youtubeChannelId], map: "uq_channel_owner_youtube")
  @@index([userId], map: "idx_channel_user")
  @@index([googleAccountId], map: "idx_channel_google_account")
}

model Video {
  id             Int           @id @default(autoincrement())
  channelId      Int
  youtubeVideoId String        @db.VarChar(128)
  title          String?       @db.VarChar(512)
  description    String?
  publishedAt    DateTime?     @db.Timestamptz(6)
  durationSec    Int?
  tags           String?
  categoryId     String?       @db.VarChar(32) // YouTube video category ID (e.g., "20" for Gaming)
  thumbnailUrl   String?
  privacyStatus  String?       @db.VarChar(16) // "public", "unlisted", or "private"
  createdAt      DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime      @default(now()) @updatedAt @db.Timestamptz(6)
  Channel        Channel       @relation(fields: [channelId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_video_channel")
  VideoMetrics   VideoMetrics?

  @@unique([channelId, youtubeVideoId], map: "uq_video_channel_youtube")
  @@index([channelId], map: "idx_video_channel")
  @@index([publishedAt], map: "idx_video_published")
}

model VideoMetrics {
  id                      Int      @id @default(autoincrement())
  videoId                 Int      @unique
  channelId               Int
  views                   Int      @default(0)
  likes                   Int      @default(0)
  comments                Int      @default(0)
  shares                  Int      @default(0)
  subscribersGained       Int      @default(0)
  subscribersLost         Int      @default(0)
  estimatedMinutesWatched Int      @default(0)
  averageViewDuration     Float    @default(0)
  averageViewPercentage   Float    @default(0)
  fetchedAt               DateTime @default(now()) @db.Timestamptz(6)
  cachedUntil             DateTime @db.Timestamptz(6)
  Video                   Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  Channel                 Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([channelId], map: "idx_video_metrics_channel")
  @@index([cachedUntil], map: "idx_video_metrics_cached")
}

model Plan {
  id             Int      @id @default(autoincrement())
  userId         Int
  channelId      Int
  // Input context snapshot
  inputsJson     String   @db.Text
  // Generated plan content (markdown)
  outputMarkdown String   @db.Text
  // Generated plan content (structured JSON)
  outputJson     String?  @db.Text
  // LLM metadata
  modelVersion   String?  @db.VarChar(64)
  tokensUsed     Int?
  // Caching
  createdAt      DateTime @default(now()) @db.Timestamptz(6)
  cachedUntil    DateTime @db.Timestamptz(6)
  User           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  Channel        Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_plan_user")
  @@index([channelId], map: "idx_plan_channel")
  @@index([createdAt], map: "idx_plan_created")
}

model OAuthState {
  id        Int      @id @default(autoincrement())
  state     String   @unique(map: "uq_oauthstate_state") @db.VarChar(128)
  userId    Int
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  expiresAt DateTime @db.Timestamptz(6)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_oauthstate_user")
}

// ============================================
// COMPETITOR VIDEO TRACKING (public stats over time)
// ============================================

model CompetitorVideo {
  id                  String                    @id @default(uuid()) @db.Uuid
  videoId             String                    @unique @db.VarChar(32) // YouTube video ID
  channelId           String                    @db.VarChar(64) // YouTube channel ID
  channelTitle        String                    @db.VarChar(255)
  title               String                    @db.VarChar(512)
  description         String?                   @db.Text
  publishedAt         DateTime                  @db.Timestamptz(6)
  durationSec         Int?
  thumbnailUrl        String?
  tags                String[]                  @default([])
  categoryId          String?                   @db.VarChar(32)
  topicDetails        Json? // topicDetails from YouTube API
  analysisJson        Json? // cached LLM analysis for competitor detail view
  analysisContentHash String?                   @db.VarChar(32) // Hash for invalidation
  analysisCapturedAt  DateTime?                 @db.Timestamptz(6)
  lastFetchedAt       DateTime                  @default(now()) @db.Timestamptz(6)
  createdAt           DateTime                  @default(now()) @db.Timestamptz(6)
  updatedAt           DateTime                  @default(now()) @updatedAt @db.Timestamptz(6)
  Snapshots           CompetitorVideoSnapshot[]
  CommentAnalysis     CompetitorVideoComments?

  @@index([channelId], map: "idx_competitor_video_channel")
  @@index([publishedAt], map: "idx_competitor_video_published")
  @@index([lastFetchedAt], map: "idx_competitor_video_last_fetched")
  @@index([analysisCapturedAt], map: "idx_competitor_video_analysis_captured")
}

model CompetitorVideoSnapshot {
  id           String          @id @default(uuid()) @db.Uuid
  videoId      String          @db.VarChar(32) // YouTube video ID
  capturedAt   DateTime        @default(now()) @db.Timestamptz(6)
  viewCount    Int
  likeCount    Int?
  commentCount Int?
  Video        CompetitorVideo @relation(fields: [videoId], references: [videoId], onDelete: Cascade)

  @@index([videoId, capturedAt(sort: Desc)], map: "idx_competitor_snapshot_video_time")
  @@index([capturedAt], map: "idx_competitor_snapshot_captured")
}

model CompetitorVideoComments {
  id              String          @id @default(uuid()) @db.Uuid
  videoId         String          @unique @db.VarChar(32) // YouTube video ID
  capturedAt      DateTime        @default(now()) @db.Timestamptz(6)
  topCommentsJson Json? // Array of top comments for reference
  contentHash     String?         @db.VarChar(32) // Hash of comments for invalidation
  analysisJson    Json? // LLM analysis result: sentiment, themes, quotes
  sentimentPos    Float? // Percentage positive
  sentimentNeu    Float? // Percentage neutral
  sentimentNeg    Float? // Percentage negative
  themesJson      Json? // Array of extracted themes
  Video           CompetitorVideo @relation(fields: [videoId], references: [videoId], onDelete: Cascade)

  @@index([capturedAt], map: "idx_competitor_comments_captured")
}

// ============================================
// API RESPONSE CACHES (reduce YouTube quota burn)
// ============================================

model SimilarChannelsCache {
  id           String   @id @default(uuid()) @db.Uuid
  userId       Int
  channelId    Int
  range        String   @db.VarChar(8)
  channels     Int
  responseJson Json
  cachedUntil  DateTime @db.Timestamptz(6)
  createdAt    DateTime @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@unique([userId, channelId, range, channels], map: "uq_similar_channels_cache")
  @@index([cachedUntil], map: "idx_similar_channels_cache_cached")
}

model CompetitorFeedCache {
  id          String   @id @default(uuid()) @db.Uuid
  userId      Int
  channelId   Int
  range       String   @db.VarChar(8)
  videosJson  Json
  cachedUntil DateTime @db.Timestamptz(6)
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@unique([userId, channelId, range], map: "uq_competitor_feed_cache")
  @@index([cachedUntil], map: "idx_competitor_feed_cache_cached")
}

model GoogleApiCallLog {
  id             String   @id @default(uuid()) @db.Uuid
  at             DateTime @default(now()) @db.Timestamptz(6)
  url            String   @db.Text
  host           String   @db.VarChar(255)
  path           String   @db.VarChar(255)
  status         String   @db.VarChar(16) // HTTP status code
  estimatedUnits Int      @default(0)

  @@index([at], map: "idx_google_api_calllog_at")
  @@index([host], map: "idx_google_api_calllog_host")
  @@index([path], map: "idx_google_api_calllog_path")
}

model YouTubeSearchCache {
  id           String   @id @default(uuid()) @db.Uuid
  kind         String   @db.VarChar(16) // "channel" | "video"
  query        String   @db.Text
  responseJson Json
  cachedUntil  DateTime @db.Timestamptz(6)
  createdAt    DateTime @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@unique([kind, query], map: "uq_youtube_search_cache")
  @@index([cachedUntil], map: "idx_youtube_search_cache_cached")
}

// ============================================
// OWNED VIDEO ANALYTICS (daily series for user's own videos)
// ============================================

model OwnedVideoAnalyticsDay {
  id                         String   @id @default(uuid()) @db.Uuid
  userId                     Int
  channelId                  Int
  videoId                    String   @db.VarChar(32) // YouTube video ID
  date                       DateTime @db.Date // YYYY-MM-DD
  views                      Int      @default(0)
  engagedViews               Int?
  comments                   Int?
  likes                      Int?
  shares                     Int?
  estimatedMinutesWatched    Int?
  averageViewDuration        Int? // seconds
  averageViewPercentage      Float?
  subscribersGained          Int?
  subscribersLost            Int?
  videosAddedToPlaylists     Int?
  videosRemovedFromPlaylists Int?
  // Monetization (may be null if not monetized)
  estimatedRevenue           Float?
  estimatedAdRevenue         Float?
  grossRevenue               Float?
  monetizedPlaybacks         Int?
  playbackBasedCpm           Float?
  adImpressions              Int?
  cpm                        Float?
  createdAt                  DateTime @default(now()) @db.Timestamptz(6)

  @@unique([userId, channelId, videoId, date], map: "uq_owned_analytics_day")
  @@index([videoId, date(sort: Desc)], map: "idx_owned_analytics_video_date")
  @@index([channelId, date(sort: Desc)], map: "idx_owned_analytics_channel_date")
}

model OwnedVideoInsightsCache {
  id          String   @id @default(uuid()) @db.Uuid
  userId      Int
  channelId   Int
  videoId     String   @db.VarChar(32) // YouTube video ID
  range       String   @db.VarChar(8) // "7d", "28d", "90d"
  contentHash String?  @db.VarChar(32) // Hash of title+desc+tags for invalidation
  derivedJson Json? // Derived metrics + baselines
  llmJson     Json? // LLM-generated insights
  cachedUntil DateTime @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@unique([userId, channelId, videoId, range], map: "uq_owned_insights_cache")
  @@index([cachedUntil], map: "idx_owned_insights_cached")
}

model OwnedVideoRemixCache {
  id          String   @id @default(uuid()) @db.Uuid
  userId      Int
  channelId   Int
  videoId     String   @db.VarChar(32) // YouTube video ID
  range       String   @db.VarChar(8) // "7d", "28d", "90d"
  seedHash    String   @db.VarChar(128)
  remixJson   Json? // { remixIdeas: [...] }
  cachedUntil DateTime @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@unique([userId, channelId, videoId, range, seedHash], map: "uq_owned_remix_cache")
  @@index([cachedUntil], map: "idx_owned_remix_cache_cached")
  @@index([userId, channelId, videoId], map: "idx_owned_remix_cache_video")
}

// ============================================
// SAVED IDEAS - User's bookmarked video ideas
// ============================================

model SavedIdea {
  id         String   @id @default(uuid()) @db.Uuid
  userId     Int
  channelId  Int? // Optional: which channel this idea is for
  ideaId     String   @db.VarChar(64) // Original idea ID from IdeaBoard
  title      String   @db.VarChar(500)
  angle      String?  @db.Text
  format     String   @db.VarChar(16) // "long" or "shorts"
  difficulty String   @db.VarChar(16) // "easy", "medium", "stretch"
  ideaJson   Json // Full idea object for rendering
  notes      String?  @db.Text // User's personal notes
  status     String   @default("saved") @db.VarChar(32) // saved, in_progress, filmed, published
  createdAt  DateTime @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@unique([userId, ideaId], map: "uq_saved_idea_user_idea")
  @@index([userId, status], map: "idx_saved_idea_user_status")
  @@index([userId, createdAt(sort: Desc)], map: "idx_saved_idea_user_created")
}

// ============================================
// SUBSCRIBER AUDIT PATTERN ANALYSIS CACHE
// ============================================

model SubscriberAuditCache {
  id           String   @id @default(uuid()) @db.Uuid
  userId       Int
  channelId    Int
  range        String   @db.VarChar(8) // "28d", "90d"
  contentHash  String   @db.VarChar(32) // Hash of top videos for invalidation
  analysisJson Json? // LLM-generated pattern analysis
  cachedUntil  DateTime @db.Timestamptz(6)
  createdAt    DateTime @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@unique([userId, channelId, range], map: "uq_subscriber_audit_cache")
  @@index([cachedUntil], map: "idx_subscriber_audit_cached")
}

// ============================================
// USAGE TRACKING (Daily limits enforcement)
// ============================================

model UsageCounter {
  id         String   @id @default(uuid()) @db.Uuid
  userId     Int
  date       DateTime @db.Date // Store date at midnight (date-only)
  featureKey String   @db.VarChar(64) // owned_video_analysis, competitor_video_analysis, etc.
  count      Int      @default(0)
  createdAt  DateTime @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@unique([userId, date, featureKey], map: "uq_usage_counter")
  @@index([userId, date], map: "idx_usage_counter_user_date")
}

// ============================================
// CHANNEL NICHE CACHE (derived from last 15 videos)
// ============================================

model ChannelNiche {
  id              String   @id @default(uuid()) @db.Uuid
  channelId       Int      @unique
  niche           String   @db.VarChar(255) // The identified niche description
  queriesJson     Json // Array of search queries for finding competitors
  videoTitlesHash String   @db.VarChar(64) // MD5 hash of video titles for change detection
  generatedAt     DateTime @default(now()) @db.Timestamptz(6)
  cachedUntil     DateTime @db.Timestamptz(6)
  createdAt       DateTime @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime @default(now()) @updatedAt @db.Timestamptz(6)
  Channel         Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([cachedUntil], map: "idx_channel_niche_cached")
}

// ============================================
// CHANNEL PROFILE (user-defined niche + AI structured)
// ============================================

model ChannelProfile {
  id              String    @id @default(uuid()) @db.Uuid
  channelId       Int       @unique
  inputJson       String    @db.Text // Raw user input (ChannelProfileInput)
  inputHash       String    @db.VarChar(64) // Hash for cache invalidation
  aiProfileJson   String?   @db.Text // AI-generated structured profile (ChannelProfileAI)
  lastGeneratedAt DateTime? @db.Timestamptz(6) // When AI profile was last generated
  createdAt       DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime  @default(now()) @updatedAt @db.Timestamptz(6)
  Channel         Channel   @relation(fields: [channelId], references: [id], onDelete: Cascade, map: "fk_channel_profile_channel")

  @@index([lastGeneratedAt], map: "idx_channel_profile_generated")
}

// ============================================
// BADGE COLLECTION SYSTEM
// ============================================

// User's unlocked badges
model UserBadge {
  id         String   @id @default(uuid()) @db.Uuid
  userId     Int
  channelId  Int? // Which channel unlocked this
  badgeId    String   @db.VarChar(64) // Badge ID from registry (e.g., "first-upload")
  unlockedAt DateTime @default(now()) @db.Timestamptz(6)
  seen       Boolean  @default(false) // Has user viewed this badge since unlock?

  @@unique([userId, channelId, badgeId], map: "uq_user_badge")
  @@index([userId], map: "idx_user_badge_user")
  @@index([channelId], map: "idx_user_badge_channel")
  @@index([unlockedAt(sort: Desc)], map: "idx_user_badge_unlocked")
}

// ============================================
// THUMBNAIL WORKFLOW - Identity + Generation + Editor Projects
// ============================================

enum UserModelStatus {
  none
  pending
  training
  ready
  failed
  canceled
  deleting
}

enum ThumbnailStyleV2 {
  compare
  subject
  object
  hold
}

enum ThumbnailJobStatusV2 {
  queued
  running
  succeeded
  failed
  canceled
}

enum ThumbnailSourceV2 {
  txt2img
  img2img
}

model UserModel {
  id                    String          @id @default(uuid()) @db.Uuid
  userId                Int             @unique
  replicateModelOwner   String          @db.VarChar(128)
  replicateModelName    String          @db.VarChar(255)
  replicateModelVersion String?         @db.VarChar(256)
  loraWeightsUrl        String?         @db.Text
  triggerWord           String          @db.VarChar(16)
  status                UserModelStatus @default(pending)
  trainingId            String?         @db.VarChar(128)
  trainingStartedAt     DateTime?       @db.Timestamptz(6)
  trainingCompletedAt   DateTime?       @db.Timestamptz(6)
  errorMessage          String?         @db.Text
  datasetHash           String?         @db.VarChar(64) // SHA256 of sorted training asset keys
  needsRetrain          Boolean         @default(false) // Coalescing flag for rapid uploads/deletes
  createdAt             DateTime        @default(now()) @db.Timestamptz(6)
  updatedAt             DateTime        @default(now()) @updatedAt @db.Timestamptz(6)

  User   User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  Assets UserTrainingAsset[]

  @@index([userId, status], map: "idx_user_model_user_status")
}

model UserTrainingAsset {
  id              String   @id @default(uuid()) @db.Uuid
  userId          Int
  identityModelId String?  @db.Uuid
  s3KeyOriginal   String   @db.VarChar(512)
  s3KeyNormalized String?  @db.VarChar(512)
  width           Int
  height          Int
  sha256          String   @db.VarChar(64)
  createdAt       DateTime @default(now()) @db.Timestamptz(6)

  User          User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  IdentityModel UserModel? @relation(fields: [identityModelId], references: [id], onDelete: SetNull)

  @@unique([userId, sha256], map: "uq_user_training_asset_user_sha")
  @@index([userId], map: "idx_user_training_asset_user")
  @@index([identityModelId], map: "idx_user_training_asset_model")
}

model ThumbnailJob {
  id                     String               @id @default(uuid()) @db.Uuid
  userId                 Int
  source                 ThumbnailSourceV2    @default(txt2img)
  style                  ThumbnailStyleV2
  styleModelVersionId    String               @db.VarChar(256)
  identityModelVersionId String?              @db.VarChar(256)
  userPrompt             String               @db.Text
  llmPrompt              String               @db.Text
  negativePrompt         String?              @db.Text
  replicatePredictionId  String?              @db.VarChar(128)
  parentJobId            String?              @db.Uuid // For img2img variants
  inputImageUrl          String?              @db.Text // Source image URL for img2img
  status                 ThumbnailJobStatusV2 @default(queued)
  outputImages           Json                 @default("[]")
  createdAt              DateTime             @default(now()) @db.Timestamptz(6)
  updatedAt              DateTime             @default(now()) @updatedAt @db.Timestamptz(6)

  User        User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ParentJob   ThumbnailJob?            @relation("ThumbnailJobVariants", fields: [parentJobId], references: [id], onDelete: SetNull)
  ChildJobs   ThumbnailJob[]           @relation("ThumbnailJobVariants")
  Predictions ThumbnailJobPrediction[]
  Projects    ThumbnailProject[]

  @@index([userId, createdAt(sort: Desc)], map: "idx_thumbnail_job_v2_user_created")
  @@index([userId, status], map: "idx_thumbnail_job_v2_user_status")
  @@index([parentJobId], map: "idx_thumbnail_job_v2_parent")
  @@map("ThumbnailJobV2")
}

model ThumbnailJobPrediction {
  id                    String   @id @default(uuid()) @db.Uuid
  thumbnailJobId        String   @db.Uuid
  replicatePredictionId String   @unique @db.VarChar(128)
  status                String   @default("starting") @db.VarChar(32)
  outputImages          Json     @default("[]")
  createdAt             DateTime @default(now()) @db.Timestamptz(6)
  updatedAt             DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  Job ThumbnailJob @relation(fields: [thumbnailJobId], references: [id], onDelete: Cascade)

  @@index([thumbnailJobId], map: "idx_thumbnail_job_pred_job")
  @@index([status], map: "idx_thumbnail_job_pred_status")
}

model ThumbnailProject {
  id             String   @id @default(uuid()) @db.Uuid
  userId         Int
  thumbnailJobId String   @db.Uuid
  baseImageUrl   String   @db.Text
  editorState    Json
  exports        Json     @default("[]")
  createdAt      DateTime @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  User User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  Job  ThumbnailJob @relation(fields: [thumbnailJobId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)], map: "idx_thumbnail_project_user_created")
  @@index([thumbnailJobId], map: "idx_thumbnail_project_job")
}

model ReplicateWebhookEvent {
  id        String   @id @db.VarChar(255) // e.g. "prediction:<id>:<status>"
  createdAt DateTime @default(now()) @db.Timestamptz(6)
}

// ============================================
// FEATURE FLAGS - Centralized feature toggles
// ============================================

model FeatureFlag {
  id          String   @id @default(uuid()) @db.Uuid
  key         String   @unique @db.VarChar(64) // e.g. "thumbnail_generation"
  enabled     Boolean  @default(false)
  description String?  @db.Text
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@index([key], map: "idx_feature_flag_key")
}

// ============================================
// USER FACE REFERENCES - For "Put Me in the Image"
// ============================================

model UserFaceReference {
  id         String   @id @default(uuid()) @db.Uuid
  userId     Int
  label      String   @db.VarChar(64) // e.g., "Primary", "Serious", "Smiling"
  storageKey String   @db.VarChar(512) // Storage key/path for the image
  mime       String   @db.VarChar(64) // image/png, image/jpeg
  width      Int?
  height     Int?
  sizeBytes  Int?
  isDefault  Boolean  @default(false) // Primary face reference
  createdAt  DateTime @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@index([userId], map: "idx_user_face_ref_user")
  @@index([userId, isDefault], map: "idx_user_face_ref_default")
}
