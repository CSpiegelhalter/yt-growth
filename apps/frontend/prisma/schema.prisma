generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int             @id @default(autoincrement())
  email         String          @unique(map: "uq_user_email") @db.VarChar(255)
  name          String?         @db.VarChar(255)
  passwordHash  String?         @db.VarChar(255)
  createdAt     DateTime        @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime        @default(now()) @updatedAt @db.Timestamptz(6)
  Channel       Channel[]
  GoogleAccount GoogleAccount[]
  OAuthState    OAuthState[]
  Subscription  Subscription?
  Plan          Plan[]

  @@index([email], map: "idx_user_email")
}

model Subscription {
  id                   Int       @id @default(autoincrement())
  userId               Int       @unique
  stripeCustomerId     String?   @db.VarChar(255)
  stripeSubscriptionId String?   @db.VarChar(255)
  status               String    @default("inactive") @db.VarChar(32) // active, past_due, canceled, inactive
  plan                 String    @default("free") @db.VarChar(32) // free, pro, team
  currentPeriodEnd     DateTime? @db.Timestamptz(6)
  channelLimit         Int       @default(1)
  createdAt            DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt            DateTime  @default(now()) @updatedAt @db.Timestamptz(6)
  User                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([stripeCustomerId], map: "idx_subscription_stripe_customer")
  @@index([stripeSubscriptionId], map: "idx_subscription_stripe_sub")
}

model GoogleAccount {
  id                Int       @id @default(autoincrement())
  userId            Int
  provider          String    @default("google") @db.VarChar(50)
  providerAccountId String    @db.VarChar(255)
  refreshTokenEnc   String?
  scopes            String?
  tokenExpiresAt    DateTime? @db.Timestamptz(6)
  createdAt         DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime  @default(now()) @updatedAt @db.Timestamptz(6)
  User              User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_google_user")

  @@unique([provider, providerAccountId], map: "uq_google_provider_account")
}

model Channel {
  id               Int             @id @default(autoincrement())
  userId           Int
  youtubeChannelId String          @db.VarChar(128)
  title            String?         @db.VarChar(255)
  thumbnailUrl     String?
  connectedAt      DateTime        @default(now()) @db.Timestamptz(6)
  lastSyncedAt     DateTime?       @db.Timestamptz(6)
  syncStatus       String          @default("idle") @db.VarChar(32)
  syncError        String?
  User             User            @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_channel_user")
  Video            Video[]
  Plan             Plan[]
  RetentionBlob    RetentionBlob[]
  VideoMetrics     VideoMetrics[]

  @@unique([userId, youtubeChannelId], map: "uq_channel_owner_youtube")
  @@index([userId], map: "idx_channel_user")
}

model Video {
  id             Int             @id @default(autoincrement())
  channelId      Int
  youtubeVideoId String          @db.VarChar(128)
  title          String?         @db.VarChar(512)
  description    String?
  publishedAt    DateTime?       @db.Timestamptz(6)
  durationSec    Int?
  tags           String?
  thumbnailUrl   String?
  createdAt      DateTime        @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime        @default(now()) @updatedAt @db.Timestamptz(6)
  Channel        Channel         @relation(fields: [channelId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_video_channel")
  RetentionBlob  RetentionBlob[]
  VideoMetrics   VideoMetrics?

  @@unique([channelId, youtubeVideoId], map: "uq_video_channel_youtube")
  @@index([channelId], map: "idx_video_channel")
  @@index([publishedAt], map: "idx_video_published")
}

model VideoMetrics {
  id                      Int      @id @default(autoincrement())
  videoId                 Int      @unique
  channelId               Int
  views                   Int      @default(0)
  likes                   Int      @default(0)
  comments                Int      @default(0)
  shares                  Int      @default(0)
  subscribersGained       Int      @default(0)
  subscribersLost         Int      @default(0)
  estimatedMinutesWatched Int      @default(0)
  averageViewDuration     Float    @default(0)
  averageViewPercentage   Float    @default(0)
  fetchedAt               DateTime @default(now()) @db.Timestamptz(6)
  cachedUntil             DateTime @db.Timestamptz(6)
  Video                   Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  Channel                 Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([channelId], map: "idx_video_metrics_channel")
  @@index([cachedUntil], map: "idx_video_metrics_cached")
}

model RetentionBlob {
  id           Int      @id @default(autoincrement())
  videoId      Int
  channelId    Int
  // JSON array of {elapsedRatio, audienceWatchRatio}
  dataJson     String   @db.Text
  // Computed cliff analysis result
  cliffTimeSec Int?
  cliffReason  String?  @db.VarChar(32) // crossed_50, steepest_drop
  cliffSlope   Float?
  fetchedAt    DateTime @default(now()) @db.Timestamptz(6)
  cachedUntil  DateTime @db.Timestamptz(6)
  Video        Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  Channel      Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([videoId], map: "uq_retention_video")
  @@index([channelId], map: "idx_retention_channel")
  @@index([cachedUntil], map: "idx_retention_cached")
}

model Plan {
  id             Int      @id @default(autoincrement())
  userId         Int
  channelId      Int
  // Input context snapshot
  inputsJson     String   @db.Text
  // Generated plan content (markdown)
  outputMarkdown String   @db.Text
  // Generated plan content (structured JSON)
  outputJson     String?  @db.Text
  // LLM metadata
  modelVersion   String?  @db.VarChar(64)
  tokensUsed     Int?
  // Caching
  createdAt      DateTime @default(now()) @db.Timestamptz(6)
  cachedUntil    DateTime @db.Timestamptz(6)
  User           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  Channel        Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_plan_user")
  @@index([channelId], map: "idx_plan_channel")
  @@index([createdAt], map: "idx_plan_created")
}

model OAuthState {
  id        Int      @id @default(autoincrement())
  state     String   @unique(map: "uq_oauthstate_state") @db.VarChar(128)
  userId    Int
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  expiresAt DateTime @db.Timestamptz(6)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_oauthstate_user")
}

// ============================================
// COMPETITOR VIDEO TRACKING (public stats over time)
// ============================================

model CompetitorVideo {
  id              String                     @id @default(uuid()) @db.Uuid
  videoId         String                     @unique @db.VarChar(32) // YouTube video ID
  channelId       String                     @db.VarChar(64)         // YouTube channel ID
  channelTitle    String                     @db.VarChar(255)
  title           String                     @db.VarChar(512)
  description     String?                    @db.Text
  publishedAt     DateTime                   @db.Timestamptz(6)
  durationSec     Int?
  thumbnailUrl    String?
  tags            String[]                   @default([])
  categoryId      String?                    @db.VarChar(32)
  topicDetails    Json?                      // topicDetails from YouTube API
  lastFetchedAt   DateTime                   @default(now()) @db.Timestamptz(6)
  createdAt       DateTime                   @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime                   @default(now()) @updatedAt @db.Timestamptz(6)
  Snapshots       CompetitorVideoSnapshot[]
  CommentAnalysis CompetitorVideoComments?

  @@index([channelId], map: "idx_competitor_video_channel")
  @@index([publishedAt], map: "idx_competitor_video_published")
  @@index([lastFetchedAt], map: "idx_competitor_video_last_fetched")
}

model CompetitorVideoSnapshot {
  id           String          @id @default(uuid()) @db.Uuid
  videoId      String          @db.VarChar(32) // YouTube video ID
  capturedAt   DateTime        @default(now()) @db.Timestamptz(6)
  viewCount    Int
  likeCount    Int?
  commentCount Int?
  Video        CompetitorVideo @relation(fields: [videoId], references: [videoId], onDelete: Cascade)

  @@index([videoId, capturedAt(sort: Desc)], map: "idx_competitor_snapshot_video_time")
  @@index([capturedAt], map: "idx_competitor_snapshot_captured")
}

model CompetitorVideoComments {
  id              String          @id @default(uuid()) @db.Uuid
  videoId         String          @unique @db.VarChar(32) // YouTube video ID
  capturedAt      DateTime        @default(now()) @db.Timestamptz(6)
  topCommentsJson Json?           // Array of top comments for reference
  analysisJson    Json?           // LLM analysis result: sentiment, themes, quotes
  sentimentPos    Float?          // Percentage positive
  sentimentNeu    Float?          // Percentage neutral
  sentimentNeg    Float?          // Percentage negative
  themesJson      Json?           // Array of extracted themes
  Video           CompetitorVideo @relation(fields: [videoId], references: [videoId], onDelete: Cascade)

  @@index([capturedAt], map: "idx_competitor_comments_captured")
}
